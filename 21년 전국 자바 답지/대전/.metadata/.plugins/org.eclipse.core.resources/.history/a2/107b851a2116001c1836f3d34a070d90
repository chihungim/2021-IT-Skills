package view;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.FlowLayout;
import java.awt.GridLayout;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.sql.SQLException;

import javax.imageio.ImageIO;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import javax.swing.border.LineBorder;

public class Sign extends BaseFrame {
	JLabel img;
	JTextField txt[] = new JTextField[3];
	String cap[] = "이름,ID,PW".split(",");
	String fpath;

	public Sign() {
		super("회원가입", 400, 250);

		var w = new JPanel(new BorderLayout(20, 20));
		var c = new JPanel(new GridLayout(0, 1));

		add(w, "West");
		add(c);

		w.add(sz(img = new JLabel(), 150, 150));
		setB(img, new LineBorder(Color.BLACK));

		w.add(btn("사진 등록", a -> {
			var jfc = new JFileChooser("./Datafiles/회원사진");
			jfc.setMultiSelectionEnabled(false);
			if (jfc.showOpenDialog(null) == JFileChooser.APPROVE_OPTION) {

			}
		}));

		for (int i = 0; i < txt.length; i++) {
			var tmp = new JPanel();
			tmp.add(sz(new JLabel(cap[i] + " : ", 2), 60, 25));
			tmp.add(txt[i] = new JTextField());
			c.add(tmp);
		}

		var c_s = new JPanel(new FlowLayout(2));
		c.add(c_s);
		c_s.add(btn("회원가입", a -> {
			var name = txt[0].getText();
			var id = txt[1].getText();
			var pw = txt[2].getText();

			if (name.isEmpty() || id.isEmpty() || pw.isEmpty()) {
				eMsg("이미 존재하는 아이디입니다.");
				txt[1].setText("");
				txt[1].requestFocus();
				return;
			}

			if (!(pw.matches(".*[0-9].*") && pw.matches(".*[a-zA-Z].*") && pw.matches(".*[\\W].*"))
					|| pw.length() < 4) {
				eMsg("비밀번호를 확인해주세요.");
				return;
			}

			if (img.getIcon() == null) {
				eMsg("사진을 등록해주세요.");
				return;
			}

			try {
				var pst = con.prepareStatement("insert into user values(0, ?, ?, ?, ?)");
				for (int i = 0; i < txt.length; i++)
					pst.setObject(i + 1, txt[i].getText());

				pst.setBinaryStream(4, new FileInputStream(new File(fpath)));
				pst.execute();
				try {
					ImageIO.write(ImageIO.read(new File(fpath)), "jpg",
							new File("./Datafiles/회원사진/" + getOne("select max(u_no) +1 from user") + ".jpg"));
					iMsg("회원가입이 완료되었습니다.");
					dispose();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (FileNotFoundException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

		}));

		c_s.add(btn("취소", a -> dispose()));

		setVisible(true);
	}
}
